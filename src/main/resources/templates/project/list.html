<!DOCTYPE html>
<!-- saved from url=(0052)http://getbootstrap.com/docs/4.0/examples/dashboard/ -->
<html
  lang="en"
  xmlns:th="http://www.thymeleaf.org"
	xmlns:v-on="http://www.w3.org/1999/xhtml"
	layout:decorate="layout/index"
>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <title>协同平台</title>

    <!-- <link href="asserts/css/bootstrap.min.css" th:href="@{/webjars/bootstrap/4.0.0/css/bootstrap.css}" rel="stylesheet">
		<link href="asserts/css/dashboard.css" th:href="@{/asserts/css/dashboard.css}" rel="stylesheet">
		<link href="asserts/element2.10.1/index.css" th:href="@{/asserts/element2.10.1/index.css}" rel="stylesheet">
		<link href="asserts/css/myCSS.css" th:href="@{/asserts/css/myCSS.css}" rel="stylesheet">
		<link href="asserts/css/myManager.css" th:href="@{/asserts/css/myManager.css}" rel="stylesheet">
		<link href="asserts/css/myCutWord.css" th:href="@{/asserts/css/myCutWord.css}" rel="stylesheet">
 		-->
    <link
      href="asserts/css/new-style.css"
      th:href="@{/asserts/css/new-style.css}"
      rel="stylesheet"
		/>
		<style>
			/* 项目列表 */
			.project-list {
				padding: 40px;
			}
			.project-list .select-zu {
				width: 300px;
			}
			.table-operate {
				display: flex;
				justify-content: space-between;
      }
      
      .custom-tree-node {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 14px;
        padding-right: 8px;
      }

      .custom-tree-node > span:first-child {
        text-overflow: ellipsis;
        background-color: #409EFF;
        padding: 2px 5px;
        color: #fff;
        width: 200px;
        overflow: hidden;
      }

      .add-project {
        display: flex;
      }
      .tree-container {
        padding: 10px;
        width: 300px;
      }
      .tree-container .el-tree {
        width: 100%;
      }
      .tree-container .el-tree-node {
        margin: 10px 0;
      }
      /* .file-tree .el-tree-node__children:before {
        content: "";
        position: absolute;
        top: -13px;
        bottom: 16px;
        left: 17px;
        width: 1px;
        border-left: 1px dashed #3150b0;
      }
      .file-tree .el-tree-node__children .custom-tree-node:before, 
      .file-tree .el-tree-node__children .el-tree-node__label:before {
        content: "";
        position: absolute;
        left: -26px;
        top: 16px;
        height: 1px;
        width: 24px;
        border-top: 1px dashed #3150b0;
      }

      .file-tree .el-tree-node__content {
        position: relative;
        margin-bottom: 12px;
        height: auto;
        padding: 0!important;
      } */

		</style>
  </head>

  <body>
    <div layout:fragment="content">
      <div class="project-list">
        <div class="dsource-wrap" style="margin-top: 0px;">
          <el-input
            hidden="true"
            v-model="pageSize"
						style="height: 0px;"
						v-show="false"
          ></el-input>

          <el-input hidden="true" v-show="false" v-model="currentDepartmentId"></el-input>

          <el-scrollbar class="dsource-r">
            <div class="ds-table-wrap">
              <nav>
                <div
                  class="nav nav-tabs"
                  role="tablist"
                  v-for="department, key in departments"
                  :key="key"
                >
                  <a
                    style="display: inline-block;"
                    :class="department.style"
                    @click="getProjectByDepartment(department.id)"
                    data-toggle="tab"
                    role="tab"
                    aria-controls="nav-home"
										aria-selected="true"
										v-if="false"
                    >{{department.departmentName}}</a
                  >
                </div>
							</nav>
							
							<div class="table-operate">
								<div class="op-left">
									<el-button size="small" type="primary" class="select-btn" @click="addProjectClick">添加项目</el-button>
								</div>
								<div class="op-right">
									<el-input
										class="select-zu"
										placeholder="输入查询内容"
										v-model="searchKey"
										size="small"
									></el-input>
									<el-button size="small" type="primary" class="select-btn" clearable @clear="searchClick" @click="searchClick">查找</el-button>
								</div>
							</div>

              <el-table
                style="width: 100%; margin-top: 10px;"
                :data="tableData"
								class="x-table table-td0"
								stripe
              >
                <el-table-column
                  type="index"
                  :index="indexMethod"
                  width="55"
									label="序号"
                ></el-table-column>
                <!--<el-table-column label="序号" width="60" type="index">-->
                <!--<template slot-scope="scope"><span>{{ scope.row.serialNumber }}</span></template>-->
                <!--</el-table-column>-->
                <el-table-column label="项目名称">
                  <template slot-scope="scope"
                    ><a target="_blank"
                      >{{ scope.row.projectName }}
                    </a></template
                  >
                </el-table-column>
                <el-table-column label="设计阶段">
                  <template slot-scope="scope">
                    <div @click="editDesignPhaseClick(scope.row)">
                      <span style="color: #080fe8;">
                        <el-link type="primary"
                          >{{ scope.row.designPhase }}</el-link
                        >
                      </span>
                    </div>
                  </template>
                </el-table-column>
                <el-table-column label="负责人">
                  <template slot-scope="scope">
                    <div @click="editProjectPrincipalClick(scope.row)">
                      <span style="color: #080fe8;">
                        <el-link type="primary"
                          >{{ scope.row.principal }}</el-link
                        >
                      </span>
                    </div>
                  </template>
                </el-table-column>
                <el-table-column label="总工">
                  <template slot-scope="scope">
                    <div @click="editProjectChiefEngineerClick(scope.row)">
                      <span style="color: #e85205;">
                        <el-link type="warning"
                          >{{ scope.row.chiefEngineer }}</el-link
                        >
                      </span>
                    </div>
                  </template>
                </el-table-column>
                <el-table-column label="开始时间">
                  <template slot-scope="scope"
                    ><span>{{ scope.row.startTime }}</span></template
                  >
                </el-table-column>
                <el-table-column label="截止时间">
                  <template slot-scope="scope"
                    ><span>{{ scope.row.stopTime }}</span></template
                  >
                </el-table-column>
                <el-table-column label="剩余天数">
                  <template slot-scope="scope"
                    ><span>{{ scope.row.leftTime }}</span></template
                  >
                </el-table-column>
                <el-table-column label="目前进度">
                  <template slot-scope="scope">
                    <span>
                      <div class="progress">
												<el-progress :percentage="scope.row.currentProcess || 0"></el-progress>
                      </div>
                    </span>
                  </template>
                </el-table-column>
                <el-table-column label="紧急程度">
                  <template slot-scope="scope">
                    <div @click="editEmergencyLevelClick(scope.row)">
                      <span style="color: #080fe8;">
                        <el-link type="primary"
                          >{{ scope.row.emergencyLevel }}</el-link
                        >
                      </span>
                    </div>
                  </template>
                </el-table-column>
                <el-table-column label="操作" min-width="100px">
                  <template slot-scope="scope">
                    <el-button type="primary" size="mini" @click="handleEdit(scope.row)">编辑</el-button>
                    <!-- <el-popconfirm
                      title="确定删除该项目吗？"
                      @onConfirm="alert('0000');deleteProjectClick(scope.row.id)"
                    > -->
                      <el-button slot="reference" type="danger" @click="deleteProjectClick(scope.row.id)" size="mini">删除</el-button>
                    <!-- </el-popconfirm> -->
                  </template>
                </el-table-column>
              </el-table>
              <el-pagination
                class="txtCenter"
                @size-change="handleSizeChange"
                @current-change="handleCurrentChange"
                :current-page.sync="currentPage"
                :page-sizes="[10,20,30,50]"
                :page-size="100"
                layout=" sizes, prev, pager, next"
								:total="total"
								background
              >
              </el-pagination>
            </div>
          </el-scrollbar>
        </div>

        <!-- 编辑负责人Modal -->
        <el-dialog
          title="编辑负责人"
          :visible.sync="dialogEditPrincipalVisible"
          width="25%"
        >
          <div class="form-group" hidden="true">
            <label>id</label>
            <input
              type="text"
              class="form-control"
              placeholder=""
              v-model="principalIdModalInput"
            />
            <input
              type="text"
              class="form-control"
              placeholder=""
              v-model="defaultprincipalUserIdModalInput"
            />
          </div>
          <div class="form-group">
            <label>负责人：</label>
            <el-select
              v-model="currentRow.principalId"
              filterable
              placeholder="请选择"
							style="width: 70%;"
							size="small"
            >
              <el-option
                v-for="item in principals"
                :key="+item.value"
                :label="item.label"
                :value="+item.value"
              ></el-option>
            </el-select>
          </div>
          <div slot="footer" class="modal-footer">
            <el-button size="small" type="primary" class="btn btn-primary" @click="editSubmit">保存</el-button>
          </div>
        </el-dialog>

        <!-- 编辑设计阶段Modal -->
        <el-dialog
          title="编辑"
          :visible.sync="dialogEditDesignPhaseVisible"
          width="25%"
        >
          <div class="form-group" hidden="true">
            <label>id</label>
            <input
              type="text"
              class="form-control"
              placeholder=""
              v-model="designPhaseIdModalInput"
            />
          </div>
          <div class="form-group">
            <label>设计阶段：</label>
            <el-select
              v-model="currentRow.designPhase"
              filterable
              placeholder="请选择"
							style="width: 70%;"
							size="small"
            >
              <el-option
                v-for="item in designPhases"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              ></el-option>
            </el-select>
          </div>
          <div slot="footer" class="modal-footer">
            <el-button size="small" type="primary" class="btn btn-primary" @click="editSubmit">
              保存
            </el-button>
          </div>
        </el-dialog>

        <!-- 编辑紧急程度Modal -->
        <el-dialog
          title="编辑"
          :visible.sync="dialogEditEmergencyLevelVisible"
          width="25%"
        >
          <div class="form-group" hidden="true">
            <label>id</label>
            <input
              type="text"
              class="form-control"
              placeholder=""
              v-model="designEmergencyLevelIdModalInput"
            />
          </div>
          <div class="form-group">
            <label>紧急程度：</label>
            <el-select
              v-model="emergencyLevelModalInput"
              filterable
              placeholder="请选择"
							style="width: 70%;"
							size="small"
            >
              <el-option
                v-for="item in emergencyLevels"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              ></el-option>
            </el-select>
          </div>
          <div slot="footer" class="modal-footer">
            <el-button size="small" type="primary" class="btn btn-primary" @click="editSubmit">
              保存
            </el-button>
          </div>
        </el-dialog>

        <!-- 编辑总工Modal -->
        <el-dialog
          title="编辑总工"
          :visible.sync="dialogEditChiefEngineerVisible"
          width="25%"
        >
          <div class="form-group" hidden="true">
            <label>id</label>
            <input
              type="text"
              class="form-control"
              placeholder=""
              v-model="chiefEngineerIdModalInput"
            />
            <input
              type="text"
              class="form-control"
              placeholder=""
              v-model="defaultChiefEngineerIdModalInput"
            />
          </div>
          <div class="form-group">
            <label>总工：</label>
            <el-select
              v-model="currentRow.chiefEngineerId"
              filterable
              placeholder="请选择"
							style="width: 70%;"
              size="small"
            >
              <el-option
                v-for="item in chiefEngineers"
                :key="item.value"
                :label="item.label"
                :value="item.value"
              ></el-option>
            </el-select>
          </div>
          <div slot="footer" class="modal-footer">
            <el-button size="small" type="primary" class="btn btn-primary" @click="editSubmit">
              保存
            </el-button>
          </div>
				</el-dialog>
				
				<!-- 添加编辑项目Modal -->
				<el-dialog
					:title="isEdit ? '编辑项目' : '添加项目'"
					:visible.sync="dialogAddProjectVisible"
					:width="currentProjectId ? '800px' : '600px'"
        >
          <div class="add-project">
            <el-form
              label-width="130px"
              :model="addProject"
              label-suffix="："
              size="small"
              :disabled="currentProjectId && !isEdit"
            >
              <el-form-item label="项目编号">
                <el-input
                  v-model="addProject.projectNum"
                  placeholder="请输入项目编号"
                  clearable
                  style="width: 300px;"
                ></el-input>
              </el-form-item>
              <el-form-item label="项目名称">
                <el-input
                  v-model="addProject.projectName"
                  placeholder="请输入项目名称"
                  clearable
                  style="width: 300px;"
                ></el-input>
              </el-form-item>
              <el-form-item label="设计阶段">
                <el-select
                  v-model="addProject.designPhase"
                  filterable
                  placeholder="请选择设计阶段"
                  style="width: 300px;"
                  size="small"
                >
                  <el-option
                    v-for="item in designPhases"
                    :key="item.value"
                    :label="item.label"
                    :value="item.value"
                  ></el-option>
                </el-select>
              </el-form-item>
              <el-form-item label="开始时间">
                <el-date-picker
                  v-model="addProject.startTime"
                  type="date"
                  placeholder="选择日期"
                  style="width: 300px;"
                ></el-date-picker>
              </el-form-item>
              <el-form-item label="截止时间">
                <el-date-picker
                  v-model="addProject.stopTime"
                  type="date"
                  placeholder="截止时间"
                  style="width: 300px;"
                ></el-date-picker>
              </el-form-item>
              <el-form-item label="项目负责人">
                <el-select
                  v-model="principalModalInput"
                  filterable
                  placeholder="请选择"
                  style="width: 300px;"
                >
                  <el-option
                    v-for="item in principals1"
                    :key="item.principalId"
                    :label="item.principal"
                    :value="item.principalId"
                  ></el-option>
                </el-select>
              </el-form-item>
              <el-form-item label="项目总工">
                <el-select
                  v-model="chiefEngineerModalInput"
                  filterable
                  placeholder="请选择"
                  style="width: 300px;"
                >
                  <el-option
                    v-for="item in chiefEngineers1"
                    :key="item.chiefEngineerId"
                    :label="item.chiefEngineer"
                    :value="item.chiefEngineerId"
                  ></el-option>
                </el-select>
              </el-form-item>
              <el-form-item label="分派部门">
                <el-select
                  v-model="selectDepartments"
                  multiple
                  placeholder="请选择"
                  style="width: 300px;"
                >
                  <el-option
                    v-for="department in departments"
                    :key="department.id"
                    :label="department.departmentName"
                    :value="department.id"
                  >
                  </el-option>
                </el-select>
              </el-form-item>
            </el-form>
            
            <div v-if="currentProjectId" class="tree-container">
              <p>文件树：</p>
              <el-scrollbar style="height: 358px">
                <file-tree :project-id="currentProjectId"></file-tree>
              </el-scrollbar>
            </div>
          </div>
					
					<div slot="footer" class="txtCenter" v-if="!isEdit">
						<el-button v-if="!currentProjectId" size="small" type="primary" class="btn btn-primary" @click="saveAddProject">
							下一步
            </el-button>
            <el-button v-if="!currentProjectId" size="small" @click="dialogAddProjectVisible = false">取消</el-button>
            <el-button v-if="currentProjectId" size="small" type="primary" class="btn btn-primary" @click="dialogAddProjectVisible = false">
							完成
						</el-button>
          </div>
          <div slot="footer" class="txtCenter" v-if="isEdit">
            <el-button size="small" type="primary" class="btn btn-primary" @click="editProjectSubmit">
							确定
            </el-button>
            <el-button size="small" @click="dialogAddProjectVisible = false">取消</el-button>
          </div>
				</el-dialog>
				</div>
			</div>
			<div layout:fragment="jscontent">
      <!-- <script
        type="text/javascript"
        src="asserts/js/jquery-3.2.1.slim.min.js"
        th:src="@{/webjars/jquery/3.3.1/jquery.js}"
      ></script>
      <script
        type="text/javascript"
        src="asserts/js/popper.min.js"
        th:src="@{/webjars/popper.js/1.11.1/dist/popper.js}"
      ></script>
      <script
        type="text/javascript"
        src="asserts/js/bootstrap.min.js"
        th:src="@{/webjars/bootstrap/4.0.0/js/bootstrap.js}"
      ></script> -->

      <script
        type="text/javascript"
        src="asserts/js/feather.min.js"
        th:src="@{/asserts/js/feather.min.js}"
      ></script>
      <!-- <script
        type="text/javascript"
        src="asserts/js/vue.js"
        th:src="@{/asserts/js/vue.js}"
      ></script>
      <script
        type="text/javascript"
        src="asserts/js/iconfont.js"
        th:src="@{/asserts/js/iconfont.js}"
      ></script>
      <script
        type="text/javascript"
        src="asserts/element2.10.1/index.js"
        th:src="@{/asserts/element2.10.1/index.js}"
      ></script> -->

      <script>
        feather.replace()
      </script>

      <script th:src="@{/asserts/js/components/fileTree.js}"></script>

      <script type="text/javascript">
				window.searchKeyWord = ''
				
				appheader.activeIndex2 = 2

        var app = new Vue({
          el: '#app',
          data: {
            dialogFormVisible: false,
            currentPage: 1,
            total: 0,
            pageSize: 10,
            tableData: null,
            searchKey: null,
            myValue: 1,
            departments: {},
            currentDepartmentId: null,
            principalIdModalInput: null,
            designPhaseIdModalInput: null,
            designEmergencyLevelIdModalInput: null,
            defaultprincipalUserIdModalInput: null,
            principalNameModalInput: null,
            degignPhaseModalInput: null,
            emergencyLevelModalInput: null,
            chiefEngineerIdModalInput: null,
            defaultChiefEngineerIdModalInput: null,
            chiefEngineerNameModalInput: null,
            dialogEditPrincipalVisible: false,
            dialogEditDesignPhaseVisible: false,
            dialogEditEmergencyLevelVisible: false,
            dialogEditChiefEngineerVisible: false,
            principals: [],
            designPhases: [
              { value: '投标阶段', label: '投标阶段' },
              { value: '前期方案研究', label: '前期方案研究' },
              { value: '初步设计', label: '初步设计' },
              { value: '施工图设计', label: '施工图设计' },
              { value: '施工配合', label: '施工配合' },
              { value: '结算', label: '结算' },
              { value: '完结', label: '完结' },
            ],
            emergencyLevels: [
              { value: '暂停', label: '暂停' },
              { value: '延缓', label: '延缓' },
              { value: '正常', label: '正常' },
              { value: '紧急', label: '紧急' },
              { value: '特急', label: '特急' },
            ],
						chiefEngineers: [],
						
						// 添加项目
						dialogAddProjectVisible: false,
						addProject: {},
						principalModalInput: null,
						chiefEngineerModalInput: null,
						selectDepartments: null,
						chiefEngineers1: [],
            principals1: [],
            currentProjectId: null,
            
            currentRow: {},
            isEdit: false
          },
          mounted () {
            this.findProjectByDepartmentId()
            // 查询所有负责人
            this.findAllPrincipals() //询所有可以当负责人的人选
            this.findAllChiefEngineers() //查询所有可以当总工的人选
          },
          methods: {
            // 查询项目列表信息
            findProjectByDepartmentId,
            // 删除项目
            deleteProjectClick,
            // 编辑
            handleEdit,
            editSubmit,
            editProjectSubmit,

            // 查询所有负责人
            findAllPrincipals,
            //查询所有可以当总工的人选
            findAllChiefEngineers, 

            handleSizeChange(val) {
              app.pageSize = val
              this.findProjectByDepartmentId()
            },
            handleCurrentChange(val) {
              this.currentPage = val
              this.findProjectByDepartmentId()
            },
            searchClick: function () {
              this.currentPage = 1
              this.findProjectByDepartmentId()
            },
            getProjectByDepartment: function (departmentId) {
              var departments = app.departments
              for (var i = 0; i < departments.length; i++) {
                if (i == departmentId - 1) {
                  departments[i].style = 'nav-item nav-link active'
                } else {
                  departments[i].style = 'nav-item nav-link'
                }
              }
              app.departments = departments
              app.currentDepartmentId = departmentId
              // findProjectByDepartmentId(departmentId) //根据所名称查询项目
            },
            saveDesignPhase: function () {
              editDesignPhaseAjaxFunction(this)
            },
            saveEmergencyLevel: function () {
              //保存编辑的紧急程度
              editEmergencyLevelAjaxFunction(this)
            },
            savePrincipal: function () {
              //保存负责人modal
              var projectId = app.principalIdModalInput
              var project_principalUserId = app.principalNameModalInput
              var defaultprincipalUserId = app.defaultprincipalUserIdModalInput
              console.log('项目id: ' + projectId)
              console.log('原负责人id: ' + defaultprincipalUserId) //默认用户id
              console.log('更改后的负责人id: ' + project_principalUserId)
              if (isNumber(project_principalUserId)) {
                //数字更新了，说明确实需要更新
                updatePrincipal(projectId, project_principalUserId, this) //更新负责人
              }
              app.dialogEditPrincipalVisible = false
            },
            saveChiefEngineer: function () {
              //保存总工modal
              var projectId = app.chiefEngineerIdModalInput
              var chiefEngineerNameModalInput = app.chiefEngineerNameModalInput
              var defaultChiefEngineerIdModalInput =
                app.defaultChiefEngineerIdModalInput
              console.log('项目id: ' + projectId)
              console.log('原总工id: ' + defaultChiefEngineerIdModalInput) //默认用户id
              console.log('更改后的负责人id: ' + chiefEngineerNameModalInput)
              if (isNumber(chiefEngineerNameModalInput)) {
                //数字更新了，说明确实需要更新
                updateChiefEngineer(
                  projectId,
                  chiefEngineerNameModalInput,
                  this
                ) //更新总工
              }
              app.dialogEditChiefEngineerVisible = false
            },
            editDesignPhaseClick: function (row) {
              //点击编辑设计阶段
              app.dialogEditDesignPhaseVisible = true
              this.currentRow = row
              // app.designPhaseIdModalInput = id
              /* var ajaxData = {}
              ajaxData.projectId = id
              $.ajax({
                data: ajaxData,
                type: 'GET',
                url: '/crud/project/findByProjectId',
                success: function (result) {
                  if (result.code == 200) {
                    app.degignPhaseModalInput = result.data.designPhase
                  } else {
                    console.log('findByProjectId 返回值失败')
                  }
                },
              }) */
            },
            //点击编辑紧急程度
            editEmergencyLevelClick: function (row) {
              app.dialogEditEmergencyLevelVisible = true
              this.currentRow = row
              /* app.designEmergencyLevelIdModalInput = id
              var ajaxData = {}
              ajaxData.projectId = id
              $.ajax({
                data: ajaxData,
                type: 'GET',
                url: '/crud/project/findByProjectId',
                success: function (result) {
                  if (result.code == 200) {
                    app.emergencyLevelModalInput = result.data.emergencyLevel
                  } else {
                    console.log('findByProjectId 返回值失败')
                  }
                },
              }) */
            },
            //点击编辑负责人
            editProjectPrincipalClick: function (row) {
              app.dialogEditPrincipalVisible = true
              this.currentRow = row
              // app.principalIdModalInput = id
              /* var ajaxData = {}
              ajaxData.projectId = id
              $.ajax({
                data: ajaxData,
                type: 'GET',
                url: '/crud/project/findByProjectId',
                success: function (result) {
                  if (result.code == 200) {
                    app.principalNameModalInput = result.data.principal
                    app.defaultprincipalUserIdModalInput =
                      result.data.principalId
                  } else {
                    console.log('findByProjectId 返回值失败')
                  }
                },
              }) */
            },
            editProjectChiefEngineerClick: function (row) {
              //点击编辑总工
              app.dialogEditChiefEngineerVisible = true
              app.currentRow = Object.assign({}, row) 
              // app.chiefEngineerIdModalInput = id
              
              /* var ajaxData = {}
              ajaxData.projectId = id
              $.ajax({
                data: ajaxData,
                type: 'GET',
                url: '/crud/project/findByProjectId',
                success: function (result) {
                  if (result.code == 200) {
                    app.chiefEngineerNameModalInput = result.data.chiefEngineer
                    app.defaultChiefEngineerIdModalInput =
                      result.data.chiefEngineerId
                  } else {
                    console.log('findByProjectId 返回值失败')
                  }
                },
              }) */
            },
            indexMethod: function (index) {
              return index + 1
						},
						
						saveAddProject: function () {
							addProject(this) //通过Modal框添加新的项目
						},
          },
        })

				getDepartments() //查询所有所信息
				findProjectSummaryPrincipals() //查找所有可以担任负责人的人选
				findProjectSummaryChiefEngineers() //查询所有可以当总项目总工的人选

        function sendAjax(ajaxData, type, url) {
          $.ajax({
            data: ajaxData,
            type: type,
            url: url,
            success: function (result) {
              if (result.code == 200) {
                app.tableData = result.data.list
                app.total = result.data.totalCount
              } else {
                console.log('返回值失败')
              }
            },
          })
        }

        /**
         * 设计阶段编辑
         * */
        function editDesignPhaseAjaxFunction(that) {
          var ajaxData = {}
          ajaxData.projectId = app.designPhaseIdModalInput
          ajaxData.degignPhaseModalInput = encodeURI(app.degignPhaseModalInput)
          $.ajax({
            data: ajaxData,
            type: 'GET',
            url: '/crud/projectSummary/editDesignPhase',
            success: function (result) {
              if (result.code == 200) {
                app.dialogEditDesignPhaseVisible = false
                findProjectBySearchKeyWordAndDeptId(
                  app.currentPage,
                  app.pageSize
                )
                that.$message({
                  message: '设计阶段编辑成功',
                  type: 'success',
                })
              } else {
                console.log('editDesignPhase 返回值失败')
              }
            },
          })
        }

        /***
         * 编辑紧急程度
         * */
        function editEmergencyLevelAjaxFunction(that) {
          var ajaxData = {}
          ajaxData.projectId = app.designEmergencyLevelIdModalInput
          ajaxData.emergencyLevel = encodeURI(app.emergencyLevelModalInput)
          $.ajax({
            data: ajaxData,
            type: 'GET',
            url: '/crud/project/editEmergencyLevel',
            success: function (result) {
              if (result.code == 200) {
                app.dialogEditEmergencyLevelVisible = false
                findProjectBySearchKeyWordAndDeptId(
                  app.currentPage,
                  app.pageSize
                )
                that.$message({
                  message: '紧急程度编辑成功',
                  type: 'success',
                })
              } else {
                console.log('editEmergencyLevelAjaxFunction 返回值失败')
              }
            },
          })
        }

        /**
         * 更新负责人
         */
        function updatePrincipal(projectId, project_principalUserId, that) {
          var ajaxData = {}
          ajaxData.projectId = projectId
          ajaxData.project_principalUserId = project_principalUserId
          ajaxData.currentDepartmentId = app.currentDepartmentId
          if (app.searchKey != null) {
            ajaxData.projectName = encodeURI(app.searchKey)
          } else {
            ajaxData.projectName = encodeURI('')
          }
          $.ajax({
            data: ajaxData,
            type: 'GET',
            url: '/crud/project/updatePrincipal',
            success: function (result) {
              if (result.code == 200) {
                app.$data.tableData = result.data
                that.$message({
                  message: '负责人编辑成功',
                  type: 'success',
                })
              } else {
                console.log('updatePrincipal 返回值失败')
              }
            },
          })
        }

        /**
         * 更新总工
         */
        function updateChiefEngineer(
          projectId,
          chiefEngineerNameModalInput,
          that
        ) {
          var ajaxData = {}
          ajaxData.projectId = projectId
          ajaxData.chiefEngineerNameModalInput = chiefEngineerNameModalInput
          ajaxData.currentDepartmentId = app.currentDepartmentId
          if (app.searchKey != null) {
            ajaxData.projectName = encodeURI(app.searchKey)
          } else {
            ajaxData.projectName = encodeURI('')
          }
          $.ajax({
            data: ajaxData,
            type: 'GET',
            url: '/crud/project/updateChiefEngineer',
            success: function (result) {
              if (result.code == 200) {
                app.$data.tableData = result.data
                that.$message({
                  message: '负责人编辑成功',
                  type: 'success',
                })
              } else {
                console.log('updateChiefEngineer 返回值失败')
              }
            },
          })
        }

        /**
         * 查询所有可以当负责人的人选
         */
        function findAllPrincipals() {
          var ajaxData = {}
          ajaxData.currentDepartmentId = 1 // app.currentDepartmentId
          $.ajax({
            data: ajaxData,
            type: 'GET',
            url: '/crud/user/findAllPrincipals',
            success: function (result) {
              if (result.code == 200) {
                var users = result.data
                var principals = []
                for (var i = 0; i < users.length; i++) {
                  var principal = {}
                  principal.value = +users[i].id
                  principal.label = users[i].username
                  principals[i] = principal
                }
                app.principals = principals
              } else {
                console.log('findAllPrincipals 返回值失败')
              }
            },
          })
        }

        /**
         * 查询所有可以当总工的人选
         */
        function findAllChiefEngineers() {
          var ajaxData = {}
          ajaxData.currentDepartmentId = 1 // app.currentDepartmentId
          $.ajax({
            data: ajaxData,
            type: 'GET',
            url: '/crud/user/findAllChiefEngineers',
            success: function (result) {
              if (result.code == 200) {
                var users = result.data
                var chiefEngineers = []
                for (var i = 0; i < users.length; i++) {
                  var chiefEngineer = {}
                  chiefEngineer.value = users[i].id
                  chiefEngineer.label = users[i].username
                  chiefEngineers[i] = chiefEngineer
                }
                app.chiefEngineers = chiefEngineers
              } else {
                console.log('findAllChiefEngineer 返回值失败')
              }
            },
          })
        }

        /**
         * 根据searchKeyWord和deptId查询 TODO delete
         */
        function findProjectBySearchKeyWordAndDeptId(currentPage, pageSize) {
          var ajaxData = {}
          ajaxData.currentPage = currentPage
          ajaxData.pageSize = pageSize
          if (app.searchKey != null) {
            ajaxData.projectName = encodeURI(app.searchKey)
          } else {
            ajaxData.projectName = encodeURI('')
          }
          var type = 'GET'
          var url = 'project/findByProjectNameAndDeptId'
          sendAjax(ajaxData, type, url)
        }

        /**
         * 根据所id查询项目
         */
        function findProjectByDepartmentId(departmentId) {
          var ajaxData = {}
          ajaxData.currentPage = this.currentPage
          ajaxData.pageSize = this.pageSize
          ajaxData.projectName = this.searchKey
          // ajaxData.departmentId = departmentId
          $.ajax({
            data: ajaxData,
            type: 'GET',
            url: '/crud/projectSummary/findByProjectNameAndRoles',
            success: function (result) {
              if (result.code == 200) {
                app.tableData = result.data.list
                app.total = result.data.totalCount
              } else {
                console.log('返回值失败')
              }
            },
          })
        }

        /**
         * 查询所有所信息，将值赋给li
         */
        function getDepartments() {
          $.ajax({
            data: null,
            type: 'GET',
            url: '/crud/department/findAll',
            success: function (result) {
              if (result.code == 200) {
                var departments = result.data
                for (var i = 0; i < departments.length; i++) {
                  if (i == 0) {
                    departments[i].style = 'nav-item nav-link active'
                    app.currentDepartmentId = departments[i].id
                    // findProjectByDepartmentId(departments[i].id) //根据所id查询项目
                  } else {
                    departments[i].style = 'nav-item nav-link'
                  }
                }
                app.departments = departments
              } else {
                console.log('getDepartments 返回值失败')
              }
            },
          })
        }

        /**
         * 判断是否是数字
         * @param val
         * @returns {boolean}
         */
        function isNumber(val) {
          if (parseFloat(val).toString() == 'NaN') {
            return false
          } else {
            return true
          }
        }

        function addProjectClick () {
					app.dialogAddProjectVisible = true
          // getDepartments() //查询所有部门信息
          this.isEdit = false
				}

				/**
				* 通过Modal框添加新的项目
				* */
				function addProject(that) {
					var ajaxData = {}
					var addProject = app.addProject
					addProject.principalId = app.principalModalInput
					addProject.chiefEngineerId = app.chiefEngineerModalInput

					var selectDepartments = app.selectDepartments
					console.log(selectDepartments.length)
					console.log(selectDepartments[0])

					if (addProject.projectNum == null || addProject.projectNum == '') {
						that.$message({
							message: '项目编号不能为空',
							type: 'warning',
						})
					} else if (
						addProject.projectName == null ||
						addProject.projectName == ''
					) {
						that.$message({
							message: '项目名称不能为空',
							type: 'warning',
						})
					} else if (
						addProject.designPhase == null ||
						addProject.designPhase == ''
					) {
						that.$message({
							message: '设计阶段不能为空',
							type: 'warning',
						})
					} else if (
						addProject.startTime == null ||
						addProject.startTime == ''
					) {
						that.$message({
							message: '开始时间不能为空',
							type: 'warning',
						})
					} else if (
						addProject.stopTime == null ||
						addProject.stopTime == ''
					) {
						that.$message({
							message: '结束时间不能为空',
							type: 'warning',
						})
					} else if (
						addProject.principalId == null ||
						addProject.principalId == ''
					) {
						that.$message({
							message: '负责人不能为空',
							type: 'warning',
						})
					} else if (
						addProject.chiefEngineerId == null ||
						addProject.chiefEngineerId == ''
					) {
						that.$message({
							message: '总工不能为空',
							type: 'warning',
						})
					} else if (
						app.selectDepartments == null ||
						app.selectDepartments.length == 0
					) {
						that.$message({
							message: '分派部门不能为空',
							type: 'warning',
						})
					} else {
						ajaxData.selectDepartments = app.selectDepartments
						ajaxData.projectSummary = encodeURI(
							JSON.stringify(app.addProject)
						)
						$.ajax({
							data: ajaxData,
							type: 'GET',
							url: 'projectSummary/addProject/',
							traditional: true,
							success: function (result) {
								if (result.code == 200) {
									// 获取项目列表
									app.findProjectByDepartmentId()
									// app.dialogAddProjectVisible = false
									app.addProject = {}
									/* app.principalModalInput = null
									app.chiefEngineerModalInput = null
									app.principals = {}
									app.chiefEngineers = {}
									app.selectDepartments = null
                  app.departments = {} */
                  
                  app.currentProjectId = result.data.id

									that.$message({
										message: '项目添加成功',
										type: 'success',
									})
								} else {
									console.log('返回值失败 addProject')
								}
							},
						})
					}
				}

					/**
				* 查询所有可以当总项目总负责人的人选
				*/
				function findProjectSummaryPrincipals() {
					var ajaxData = {}
					ajaxData.currentDepartmentId = 1
					$.ajax({
						data: ajaxData,
						type: 'GET',
						url: '/crud/user/findProjectSummaryPrincipals',
						success: function (result) {
							if (result.code == 200) {
								var users = result.data
								var principals = []
								for (var i = 0; i < users.length; i++) {
									var principal = {}
									principal.principal = users[i].username
									principal.principalId = users[i].id
									principals[i] = principal
								}
								app.principals1 = principals
							} else {
								console.log('findProjectSummaryPrincipals 返回值失败')
							}
						},
					})
				}

				/**
					* 查询所有可以当总项目总工的人选
					*/
				function findProjectSummaryChiefEngineers() {
					var ajaxData = {}
					ajaxData.currentDepartmentId = 1
					$.ajax({
						data: ajaxData,
						type: 'GET',
						url: '/crud/user/findProjectSummaryChiefEngineers',
						success: function (result) {
							if (result.code == 200) {
								var users = result.data
								var chiefEngineers = []
								for (var i = 0; i < users.length; i++) {
									var chiefEngineer = {}
									chiefEngineer.chiefEngineer = users[i].username
									chiefEngineer.chiefEngineerId = users[i].id
									chiefEngineers[i] = chiefEngineer
								}
								app.chiefEngineers1 = chiefEngineers
							} else {
								console.log('findAllChiefEngineer 返回值失败')
							}
						},
					})
				}

        /**
          * 删除项目
          */
        function deleteProjectClick (id) {
          let _this = this 
          let ajaxData = {
            id
          }
          this.$confirm('此操作将永久删除该项目, 是否继续?', '提示', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
          }).then(() => {
            $.ajax({
              data: ajaxData,
              type: 'GET',
              url: '/crud/projectSummary/delete',
              success: function (result) {
                if (result.code == 200) {
                  _this.$message.success('删除项目成功')
                  _this.findProjectByDepartmentId()
                } else {
                  _this.$message.errir('删除项目失败')
                }
              }
            })
          }).catch(() => {
            this.$message({
              type: 'info',
              message: '已取消删除'
            });          
          });
        }
      
        /**
         * 编辑项目
          */
        function handleEdit (row) {
          console.log(row)
          this.isEdit = true
          this.currentProjectId = row.id
          this.currentRow = row
          this.dialogAddProjectVisible = true
          this.addProject = Object.assign({}, row)
          this.principalModalInput = row.principalId
          this.chiefEngineerModalInput = row.chiefEngineerId
          this.selectDepartments = []
        }
        function editSubmit () {
          const _this = this
          let ajaxData = {
            projectSummary: JSON.stringify(this.currentRow)
          }
          $.ajax({
              data: ajaxData,
              type: 'GET',
              url: '/crud/projectSummary/update',
              success: function (result) {
                if (result.code == 200) {
                  _this.$message.success('编辑项目成功')
                  
                  _this.dialogEditPrincipalVisible = false
                  _this.dialogEditDesignPhaseVisible = false
                  _this.dialogEditEmergencyLevelVisible = false
                  _this.dialogEditChiefEngineerVisible = false
                  _this.dialogAddProjectVisible = false

                  _this.findProjectByDepartmentId()
                } else {
                  _this.$message.errir('编辑项目失败')
                }
              }
            })
        }

        function editProjectSubmit () {
          this.currentRow = Object.assign(this.currentRow, this.addProject)
          this.currentRow.principalId = this.principalModalInput
          this.currentRow.chiefEngineerId = this.chiefEngineerModalInput
          this.currentRow.selectDepartments = this.selectDepartments

          this.editSubmit()
        }
      </script>
		</div>
  </body>
</html>
